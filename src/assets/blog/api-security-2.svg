<svg viewBox="0 0 1400 900" xmlns="http://www.w3.org/2000/svg">
  <!-- Dark background -->
  <rect width="1400" height="900" fill="#0f172a"/>

  <!-- Title -->
  <text x="700" y="40" text-anchor="middle" fill="#f1f5f9" font-size="24" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">OAuth 2.0 Authentication Flow with PKCE</text>
  <text x="700" y="65" text-anchor="middle" fill="#94a3b8" font-size="14" font-family="system-ui, -apple-system, sans-serif">Healthcare API Security - Authorization Code Flow</text>

  <!-- Actors -->
  <g id="actors">
    <!-- User/Mobile App -->
    <rect x="50" y="100" width="140" height="700" rx="8" fill="#1e293b" stroke="#3b82f6" stroke-width="2"/>
    <text x="120" y="130" text-anchor="middle" fill="#3b82f6" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">User</text>
    <text x="120" y="150" text-anchor="middle" fill="#3b82f6" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Mobile App</text>

    <!-- Authorization Server -->
    <rect x="400" y="100" width="180" height="700" rx="8" fill="#1e293b" stroke="#8b5cf6" stroke-width="2"/>
    <text x="490" y="130" text-anchor="middle" fill="#8b5cf6" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Authorization</text>
    <text x="490" y="150" text-anchor="middle" fill="#8b5cf6" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Server</text>
    <text x="490" y="170" text-anchor="middle" fill="#c4b5fd" font-size="11" font-family="system-ui, -apple-system, sans-serif">(OAuth 2.0 + SMART)</text>

    <!-- Resource Server (API) -->
    <rect x="800" y="100" width="180" height="700" rx="8" fill="#1e293b" stroke="#10b981" stroke-width="2"/>
    <text x="890" y="130" text-anchor="middle" fill="#10b981" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Resource Server</text>
    <text x="890" y="150" text-anchor="middle" fill="#10b981" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">(Healthcare API)</text>
    <text x="890" y="170" text-anchor="middle" fill="#6ee7b7" font-size="11" font-family="system-ui, -apple-system, sans-serif">FHIR / Patient Data</text>

    <!-- Database -->
    <rect x="1110" y="100" width="150" height="700" rx="8" fill="#1e293b" stroke="#ec4899" stroke-width="2"/>
    <text x="1185" y="130" text-anchor="middle" fill="#ec4899" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Patient</text>
    <text x="1185" y="150" text-anchor="middle" fill="#ec4899" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Database</text>
  </g>

  <!-- Timeline vertical lines -->
  <line x1="120" y1="180" x2="120" y2="800" stroke="#334155" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="490" y1="180" x2="490" y2="800" stroke="#334155" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="890" y1="180" x2="890" y2="800" stroke="#334155" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="1185" y1="180" x2="1185" y2="800" stroke="#334155" stroke-width="2" stroke-dasharray="5,5"/>

  <!-- Flow Steps -->
  <g id="flow">
    <!-- Step 1: Generate PKCE -->
    <rect x="30" y="200" width="180" height="50" rx="6" fill="#1e3a8a" stroke="#3b82f6" stroke-width="2"/>
    <text x="120" y="220" text-anchor="middle" fill="#93c5fd" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">1. Generate PKCE</text>
    <text x="120" y="235" text-anchor="middle" fill="#93c5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">code_verifier (random)</text>
    <text x="120" y="247" text-anchor="middle" fill="#93c5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">code_challenge = hash(verifier)</text>

    <!-- Step 2: Authorization Request -->
    <line x1="120" y1="260" x2="490" y2="280" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)"/>
    <text x="280" y="255" text-anchor="middle" fill="#3b82f6" font-size="11" font-family="system-ui, -apple-system, sans-serif">2. Authorization Request</text>
    <text x="280" y="270" text-anchor="middle" fill="#93c5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">+ code_challenge + PKCE method</text>

    <!-- Step 3: User Authentication -->
    <rect x="400" y="290" width="180" height="50" rx="6" fill="#581c87" stroke="#8b5cf6" stroke-width="2"/>
    <text x="490" y="310" text-anchor="middle" fill="#c4b5fd" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">3. User Authentication</text>
    <text x="490" y="325" text-anchor="middle" fill="#c4b5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">Validate credentials</text>
    <text x="490" y="337" text-anchor="middle" fill="#c4b5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">Request consent</text>

    <!-- Step 4: Authorization Code -->
    <line x1="490" y1="350" x2="120" y2="370" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowPurple)"/>
    <text x="280" y="345" text-anchor="middle" fill="#8b5cf6" font-size="11" font-family="system-ui, -apple-system, sans-serif">4. Authorization Code</text>
    <text x="280" y="360" text-anchor="middle" fill="#c4b5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">(short-lived, single-use)</text>

    <!-- Step 5: Token Exchange -->
    <line x1="120" y1="380" x2="490" y2="400" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)"/>
    <text x="280" y="375" text-anchor="middle" fill="#3b82f6" font-size="11" font-family="system-ui, -apple-system, sans-serif">5. Token Exchange</text>
    <text x="280" y="390" text-anchor="middle" fill="#93c5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">code + code_verifier</text>

    <!-- Step 6: Validate PKCE -->
    <rect x="400" y="410" width="180" height="50" rx="6" fill="#581c87" stroke="#8b5cf6" stroke-width="2"/>
    <text x="490" y="430" text-anchor="middle" fill="#c4b5fd" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">6. Validate PKCE</text>
    <text x="490" y="445" text-anchor="middle" fill="#c4b5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">hash(code_verifier)</text>
    <text x="490" y="457" text-anchor="middle" fill="#c4b5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">== code_challenge?</text>

    <!-- Step 7: Issue Tokens -->
    <line x1="490" y1="470" x2="120" y2="490" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <text x="280" y="465" text-anchor="middle" fill="#10b981" font-size="11" font-family="system-ui, -apple-system, sans-serif">7. Access + Refresh Tokens</text>
    <text x="280" y="480" text-anchor="middle" fill="#6ee7b7" font-size="10" font-family="system-ui, -apple-system, sans-serif">access_token (15min exp)</text>
    <text x="280" y="492" text-anchor="middle" fill="#6ee7b7" font-size="10" font-family="system-ui, -apple-system, sans-serif">refresh_token (single-use)</text>

    <!-- Step 8: API Request -->
    <line x1="120" y1="510" x2="890" y2="530" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)"/>
    <text x="480" y="505" text-anchor="middle" fill="#3b82f6" font-size="11" font-family="system-ui, -apple-system, sans-serif">8. API Request</text>
    <text x="480" y="520" text-anchor="middle" fill="#93c5fd" font-size="10" font-family="system-ui, -apple-system, sans-serif">Authorization: Bearer {access_token}</text>

    <!-- Step 9: Validate Token -->
    <rect x="800" y="540" width="180" height="65" rx="6" fill="#064e3b" stroke="#10b981" stroke-width="2"/>
    <text x="890" y="560" text-anchor="middle" fill="#6ee7b7" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">9. Validate JWT</text>
    <text x="890" y="575" text-anchor="middle" fill="#6ee7b7" font-size="10" font-family="system-ui, -apple-system, sans-serif">✓ Signature valid?</text>
    <text x="890" y="588" text-anchor="middle" fill="#6ee7b7" font-size="10" font-family="system-ui, -apple-system, sans-serif">✓ Not expired?</text>
    <text x="890" y="601" text-anchor="middle" fill="#6ee7b7" font-size="10" font-family="system-ui, -apple-system, sans-serif">✓ aud, iss claims valid?</text>

    <!-- Step 10: Authorization Check -->
    <rect x="800" y="615" width="180" height="50" rx="6" fill="#064e3b" stroke="#10b981" stroke-width="2"/>
    <text x="890" y="635" text-anchor="middle" fill="#6ee7b7" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">10. Authorization Check</text>
    <text x="890" y="650" text-anchor="middle" fill="#6ee7b7" font-size="10" font-family="system-ui, -apple-system, sans-serif">Can user access Patient X?</text>
    <text x="890" y="662" text-anchor="middle" fill="#6ee7b7" font-size="10" font-family="system-ui, -apple-system, sans-serif">Patient attribution check</text>

    <!-- Step 11: Query Database -->
    <line x1="890" y1="675" x2="1185" y2="685" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <text x="1020" y="670" text-anchor="middle" fill="#10b981" font-size="11" font-family="system-ui, -apple-system, sans-serif">11. Query Data</text>

    <!-- Step 12: Return Data -->
    <line x1="1185" y1="695" x2="890" y2="705" stroke="#ec4899" stroke-width="2" marker-end="url(#arrowPink)"/>
    <text x="1020" y="690" text-anchor="middle" fill="#ec4899" font-size="11" font-family="system-ui, -apple-system, sans-serif">12. Patient Data</text>

    <!-- Step 13: Response -->
    <line x1="890" y1="715" x2="120" y2="735" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <text x="480" y="710" text-anchor="middle" fill="#10b981" font-size="11" font-family="system-ui, -apple-system, sans-serif">13. API Response (200 OK)</text>
    <text x="480" y="725" text-anchor="middle" fill="#6ee7b7" font-size="10" font-family="system-ui, -apple-system, sans-serif">Filtered patient data (no PHI in logs)</text>
  </g>

  <!-- Refresh Token Flow -->
  <g id="refresh-flow">
    <rect x="20" y="760" width="200" height="30" rx="6" fill="#422006" stroke="#f59e0b" stroke-width="2"/>
    <text x="120" y="780" text-anchor="middle" fill="#fbbf24" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Refresh Token Rotation</text>

    <line x1="220" y1="775" x2="370" y2="775" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowOrange)"/>
    <text x="290" y="770" text-anchor="middle" fill="#fbbf24" font-size="10" font-family="system-ui, -apple-system, sans-serif">refresh_token</text>

    <rect x="370" y="760" width="210" height="30" rx="6" fill="#422006" stroke="#f59e0b" stroke-width="2"/>
    <text x="475" y="780" text-anchor="middle" fill="#fbbf24" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">New Access + Refresh Tokens</text>

    <line x1="475" y1="760" x2="475" y2="740" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowOrange)"/>
    <text x="495" y="748" fill="#fbbf24" font-size="10" font-family="system-ui, -apple-system, sans-serif">Old refresh revoked</text>
  </g>

  <!-- Error Scenarios Box -->
  <g id="error-scenarios">
    <rect x="1040" y="200" width="320" height="240" rx="8" fill="#1e293b" stroke="#ef4444" stroke-width="2"/>
    <text x="1200" y="230" text-anchor="middle" fill="#ef4444" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Error Scenarios</text>

    <text x="1060" y="255" fill="#f87171" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">❌ Invalid PKCE Verifier</text>
    <text x="1070" y="272" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">→ 400 Bad Request</text>
    <text x="1070" y="286" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">→ Reject token exchange</text>

    <text x="1060" y="308" fill="#f87171" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">❌ Token Expired</text>
    <text x="1070" y="325" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">→ 401 Unauthorized</text>
    <text x="1070" y="339" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">→ Client uses refresh token</text>

    <text x="1060" y="361" fill="#f87171" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">❌ Invalid aud/iss Claims</text>
    <text x="1070" y="378" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">→ 403 Forbidden</text>
    <text x="1070" y="392" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">→ Token for wrong API</text>

    <text x="1060" y="414" fill="#f87171" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">❌ Unauthorized Patient Access</text>
    <text x="1070" y="431" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">→ 403 Forbidden</text>
    <text x="1070" y="445" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">→ Log security event</text>
  </g>

  <!-- JWT Claims Box -->
  <g id="jwt-claims">
    <rect x="1040" y="460" width="320" height="200" rx="8" fill="#1e293b" stroke="#3b82f6" stroke-width="2"/>
    <text x="1200" y="490" text-anchor="middle" fill="#3b82f6" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">JWT Claims Validation</text>

    <text x="1060" y="515" fill="#93c5fd" font-size="11" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Required Claims:</text>

    <text x="1070" y="535" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">• iss (issuer) - Authorization server URL</text>
    <text x="1070" y="552" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">• sub (subject) - Opaque user identifier</text>
    <text x="1070" y="569" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">• aud (audience) - This API's identifier</text>
    <text x="1070" y="586" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">• exp (expiration) - 15 minutes max</text>
    <text x="1070" y="603" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">• iat (issued at) - Token creation time</text>
    <text x="1070" y="620" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">• scope - FHIR resource permissions</text>
    <text x="1070" y="637" fill="#cbd5e1" font-size="10" font-family="system-ui, -apple-system, sans-serif">• patient - Patient context (if applicable)</text>
  </g>

  <!-- Security Best Practices -->
  <g id="best-practices">
    <rect x="1040" y="680" width="320" height="120" rx="8" fill="#1e293b" stroke="#10b981" stroke-width="2"/>
    <text x="1200" y="710" text-anchor="middle" fill="#10b981" font-size="14" font-weight="bold" font-family="system-ui, -apple-system, sans-serif">Security Best Practices</text>

    <text x="1060" y="735" fill="#6ee7b7" font-size="11" font-family="system-ui, -apple-system, sans-serif">✓ PKCE prevents auth code interception</text>
    <text x="1060" y="753" fill="#6ee7b7" font-size="11" font-family="system-ui, -apple-system, sans-serif">✓ Short-lived access tokens (15min)</text>
    <text x="1060" y="771" fill="#6ee7b7" font-size="11" font-family="system-ui, -apple-system, sans-serif">✓ Single-use refresh token rotation</text>
    <text x="1060" y="789" fill="#6ee7b7" font-size="11" font-family="system-ui, -apple-system, sans-serif">✓ Patient-level authorization checks</text>
  </g>

  <!-- Arrow markers -->
  <defs>
    <marker id="arrowBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#3b82f6"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#8b5cf6"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#10b981"/>
    </marker>
    <marker id="arrowPink" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#ec4899"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#f59e0b"/>
    </marker>
  </defs>
</svg>